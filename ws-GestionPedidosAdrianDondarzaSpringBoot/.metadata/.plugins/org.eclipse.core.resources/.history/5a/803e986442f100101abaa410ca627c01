package com.adriandondarza.gestionpedidos.springboot.front;

import com.adriandondarza.gestionpedidos.springboo.GestionPedidosApplication;
import com.adriandondarza.gestionpedidos.springboot.controller.InfoFiscalController;
import com.adriandondarza.gestionpedidos.springboot.dto.InfoFiscalDTO;
import com.adriandondarza.gestionpedidos.springboot.model.*;
import com.adriandondarza.gestionpedidos.springboot.repository.*;
import org.springframework.boot.builder.SpringApplicationBuilder;
import org.springframework.context.ConfigurableApplicationContext;

import java.math.BigDecimal;
import java.time.LocalDateTime;

/**
 * Aplicación de Gestión de Pedidos - Flujo de Inserción Profesional
 */
public class App {

    public static void main(String[] args) {
        // 1. Inicialización del contexto de Spring
        ConfigurableApplicationContext context = new SpringApplicationBuilder(GestionPedidosApplication.class)
                .profiles("dev").run(args);

        // 2. Obtención de controladores y repositorios
        InfoFiscalController infoFiscalCtrl = context.getBean(InfoFiscalController.class);
        ClienteRepository clienteRepo = context.getBean(ClienteRepository.class);
        ArticuloRepository articuloRepo = context.getBean(ArticuloRepository.class);
        CompraRepository compraRepo = context.getBean(CompraRepository.class);
        ArticuloCompraRepository lineaRepo = context.getBean(ArticuloCompraRepository.class);

        // Generamos un NIF único basado en el tiempo actual para evitar colisiones
        String nifSesion = "NIF-" + (System.currentTimeMillis() % 1000000);

        System.out.println("\n>>> INICIANDO FLUJO DE DATOS EN ORACLE <<<");

        try {
            // --- PASO 1: REGISTRO DE CLIENTE E INFO FISCAL ---
            System.out.println("[INFO] Insertando Cliente y su Información Fiscal asociada...");
            InfoFiscalDTO registro = new InfoFiscalDTO(nifSesion, "Polígono Industrial Norte", "925112233", "Adrian Dondarza SL");
            infoFiscalCtrl.registrarInfoFiscal(registro);
            System.out.println("[OK] Cliente e InfoFiscal guardados (NIF: " + nifSesion + ")");

            // --- PASO 2: CREACIÓN DE ARTÍCULO ---
            System.out.println("[INFO] Añadiendo nuevo producto al catálogo...");
            Articulo nuevoArt = new Articulo();
            nuevoArt.setNombre("Tarjeta Gráfica RTX 4080");
            nuevoArt.setDescripcion("Componente de alto rendimiento para gaming y diseño");
            nuevoArt.setPrecioActual(new BigDecimal("1200.00"));
            nuevoArt.setStock(15);
            nuevoArt.setActivo(true);
            nuevoArt = articuloRepo.save(nuevoArt);
            System.out.println("[OK] Artículo persistido (ID: " + nuevoArt.getId() + ")");

            // --- PASO 3: PROCESAMIENTO DE COMPRA (3 UNIDADES) ---
            System.out.println("[INFO] Generando pedido de 3 unidades para el cliente...");
            
            // Recuperamos el cliente creado anteriormente
            Cliente cliente = clienteRepo.findById(nifSesion).get();
            
            // Calculamos el total de la cabecera
            int unidades = 3;
            BigDecimal totalPedido = nuevoArt.getPrecioActual().multiply(new BigDecimal(unidades));

            Compra compra = new Compra();
            compra.setCliente(cliente);
            compra.setFechaRealizada(LocalDateTime.now());
            compra.setEstado(EstadoCompra.PENDIENTE);
            compra.setPrecioTotal(totalPedido);
            compra = compraRepo.save(compra);

            // Creamos la línea de detalle (ArticuloCompra)
            ArticuloCompra detalle = new ArticuloCompra();
            detalle.setCompra(compra);
            detalle.setArticulo(nuevoArt);
            detalle.setUnidades(unidades);
            detalle.setPrecioCompra(nuevoArt.getPrecioActual());
            lineaRepo.save(detalle);
            
            System.out.println("[OK] Compra y Detalle registrados. Total Facturado: " + totalPedido + "€");

            // --- SECCIONES DE PRUEBA (COMENTADAS) ---
            
            /* // PRUEBA DE ELIMINACIÓN (Bloqueada por Triggers en Oracle)
            System.out.println("\n[TEST] Intentando eliminar el artículo recién creado...");
            articuloRepo.delete(nuevoArt); 
            */

            /* // PRUEBA DE VALIDACIÓN DE DUPLICADOS (Bloqueada por Service Java)
            System.out.println("\n[TEST] Intentando registrar de nuevo el mismo NIF...");
            infoFiscalCtrl.registrarInfoFiscal(registro);
            */

            System.out.println("\n>>> PROCESO COMPLETADO CON ÉXITO <<<");

        } catch (Exception e) {
            System.err.println("\n[ERROR] Se ha producido un fallo inesperado: " + e.getMessage());
            e.printStackTrace();
        } finally {
            // Cerramos el contexto de Spring de forma limpia
            context.close();
        }
    }
}