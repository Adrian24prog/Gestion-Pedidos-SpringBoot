package com.adriandondarza.gestionpedidos.springboot.front;

import com.adriandondarza.gestionpedidos.springboo.GestionPedidosApplication;
import com.adriandondarza.gestionpedidos.springboot.controller.InfoFiscalController;
import com.adriandondarza.gestionpedidos.springboot.controller.ArticuloController;
import com.adriandondarza.gestionpedidos.springboot.controller.CompraController;
import com.adriandondarza.gestionpedidos.springboot.dto.*;
import org.springframework.boot.builder.SpringApplicationBuilder;
import org.springframework.context.ConfigurableApplicationContext;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.List;

/**
 * Aplicación de escritorio (Client Side) que consume la librería de Gestión de Pedidos.
 * <p>
 * Siguiendo las restricciones del enunciado, esta clase SOLO accede a la capa 
 * de Controllers y DTOs, respetando el encapsulamiento de la lógica de negocio 
 * y la persistencia de la librería.
 * </p>
 *
 * @author Adrian Dondarza
 * @version 1.3
 */
public class App {

    public static void main(String[] args) {
        // 1. Inicialización del contexto de Spring Boot (Carga de la librería)
        ConfigurableApplicationContext context = new SpringApplicationBuilder(GestionPedidosApplication.class)
                .profiles("dev").run(args);

        // 2. OBTENCIÓN DE BEANS (Únicamente Controllers permitidos)
        InfoFiscalController infoFiscalCtrl = context.getBean(InfoFiscalController.class);
        ArticuloController articuloCtrl = context.getBean(ArticuloController.class);
        CompraController compraCtrl = context.getBean(CompraController.class);

        // NIF de prueba fijo
        String nifSesion = "05478745D";

        System.out.println("\n>>> ACCESO A LIBRERÍA: FLUJO DE CONTROLADORES <<<");

        try {
            // --- FASE 1: REGISTRO DE IDENTIDAD (Controller) ---
            System.out.println("[INFO] Registrando cliente a través de InfoFiscalController...");
            InfoFiscalDTO registroDto = new InfoFiscalDTO(nifSesion, "Polígono Industrial Norte", "925112233", "Adrian Dondarza SL");
            infoFiscalCtrl.registrarInfoFiscal(registroDto);
            System.out.println("[OK] Cliente persistido.");

            // --- FASE 2: GESTIÓN DE CATÁLOGO (Controller) ---
            System.out.println("[INFO] Creando artículo a través de ArticuloController...");
            ArticuloDTO dtoArt = new ArticuloDTO(null, "Tarjeta Gráfica RTX 408000", "Componente de alto rendimiento", 
                                                 new BigDecimal("1200.00"), 15, true);
            
            // La librería valida duplicados internamente en su capa de servicio
            ArticuloDTO artGuardado = articuloCtrl.crearArticulo(dtoArt);
            System.out.println("[OK] Artículo registrado con ID: " + artGuardado.getId());

            // --- FASE 3: PROCESAMIENTO DE COMPRA (Controller) ---
            // Cumpliendo con el encapsulamiento, enviamos un DTO de registro de compra
            System.out.println("[INFO] Solicitando compra al CompraController...");
            
            List<LineaCompraDTO> lineas = new ArrayList<>();
            lineas.add(new LineaCompraDTO(artGuardado.getId(), 3)); // 3 unidades del artículo creado

            CompraRegistroDTO pedido = new CompraRegistroDTO();
            pedido.setClienteNif(nifSesion);
            pedido.setDireccionEnvio("Calle Principal s/n");
            pedido.setLineas(lineas);

            // El controlador devuelve la respuesta procesada
            CompraRespuestaDTO respuesta = compraCtrl.procesarPedido(pedido);
            
            System.out.println("[OK] Compra finalizada. Total Facturado: " + respuesta.getPrecioTotal() + "€");
            System.out.println(">>> PROCESO COMPLETADO CON ÉXITO <<<");

        } catch (Exception e) {
            // Captura de validaciones (NIF, Teléfono, Nombre Duplicado, Stock)
            System.err.println("\n[ERROR DE LIBRERÍA] " + e.getMessage());
        } finally {
            // Cierre del contexto de Spring
            context.close();
        }
    }
}