package com.adriandondarza.gestionpedidos.springboot.front;

import com.adriandondarza.gestionpedidos.springboot.GestionPedidosApplication;
import com.adriandondarza.gestionpedidos.springboot.controller.*;
import com.adriandondarza.gestionpedidos.springboot.dto.InfoFiscalDTO;
import com.adriandondarza.gestionpedidos.springboot.model.*;
import com.adriandondarza.gestionpedidos.springboot.repository.*;
import org.springframework.boot.builder.SpringApplicationBuilder;
import org.springframework.context.ConfigurableApplicationContext;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.List;

public class App {

    // Datos de prueba para la creación dual
    private static final String NIF_TEST = "B12345678";
    private static final String NOMBRE_TEST = "Adrian Dondarza";
    private static final String TEL_TEST = "600111222";
    private static final String DIR_TEST = "Calle de la Prueba 123, Valencia";

    public static void main(String[] args) {
        // 1. Iniciar contexto de Spring Boot (Carga el JAR del Backend)
        ConfigurableApplicationContext context = new SpringApplicationBuilder(GestionPedidosApplication.class)
                .profiles("dev")
                .run(args);

        System.out.println("\n>>> SISTEMA CARGADO - INICIANDO DEMOSTRACIÓN FINAL <<<");

        // 2. Obtener Controladores y Repositorios
        InfoFiscalController infoFiscalCtrl = context.getBean(InfoFiscalController.class);
        ClienteRepository clienteRepo = context.getBean(ClienteRepository.class);
        ArticuloRepository articuloRepo = context.getBean(ArticuloRepository.class);
        CompraRepository compraRepo = context.getBean(CompraRepository.class);
        ArticuloCompraRepository lineaRepo = context.getBean(ArticuloCompraRepository.class);

        try {
            // --- PASO 1: CREACIÓN EN CASCADA (PADRE -> HIJO) ---
            System.out.println("\n[OPERACIÓN] CREANDO INFO FISCAL Y CLIENTE SIMULTÁNEAMENTE:");
            
            if (clienteRepo.existsById(NIF_TEST)) {
                System.out.println("- El registro ya existe. Limpiando para la prueba...");
                infoFiscalCtrl.eliminarInfoFiscal(NIF_TEST);
            }

            // Preparamos el DTO (Capa de transporte)
            InfoFiscalDTO registro = new InfoFiscalDTO();
            registro.setNifCif(NIF_TEST);
            registro.setNombreCliente(NOMBRE_TEST);
            registro.setDireccionFiscal(DIR_TEST);
            registro.setTelefono(TEL_TEST);

            // Guardamos el padre. El Service se encarga de crear el Cliente dentro.
            infoFiscalCtrl.registrarInfoFiscal(registro);
            System.out.println("- ÉXITO: Registros creados en tablas CLIENTES e INFORMACION_FISCAL.");

            // --- PASO 2: OPERACIÓN CON ARTÍCULO ---
            System.out.println("\n[OPERACIÓN] CREANDO ARTÍCULO:");
            Articulo art = new Articulo();
            art.setNombre("Monitor 144Hz");
            art.setDescripcion("Panel IPS 1ms");
            art.setPrecioActual(new BigDecimal("199.99"));
            art.setStock(20);
            art.setActivo(true);
            art = articuloRepo.save(art);
            System.out.println("- Artículo guardado con ID: " + art.getId());

            // --- PASO 3: REALIZAR COMPRA ---
            System.out.println("\n[OPERACIÓN] REGISTRANDO COMPRA:");
            // Recuperamos el cliente que acabamos de crear por cascada
            Cliente clienteCreado = clienteRepo.findById(NIF_TEST).get();

            Compra compra = new Compra();
            compra.setCliente(clienteCreado);
            compra.setFechaRealizada(LocalDateTime.now());
            compra.setEstado(EstadoCompra.PENDIENTE);
            compra.setPrecioTotal(art.getPrecioActual());
            compra = compraRepo.save(compra);

            // Detalle de compra
            ArticuloCompra detalle = new ArticuloCompra();
            detalle.setCompra(compra);
            detalle.setArticulo(art);
            detalle.setUnidades(1);
            detalle.setPrecioCompra(art.getPrecioActual());
            lineaRepo.save(detalle);
            System.out.println("- Compra registrada para el cliente: " + clienteCreado.getNombre());

            // --- PASO 4: LISTADO Y VERIFICACIÓN ---
            System.out.println("\n[READ] LISTADO DE CLIENTES Y SU INFO FISCAL:");
            clienteRepo.findAll().forEach(c -> {
                String info = (c.getInformacionFiscal() != null) ? "CON INFO FISCAL" : "SIN INFO FISCAL";
                System.out.println("  > " + c.getNifCif() + " | " + c.getNombre() + " | [" + info + "]");
            });

            // --- PASO 5: BORRADO EN CASCADA (LA PRUEBA DEFINITIVA) ---
            System.out.println("\n[DELETE] BORRANDO PADRE (INFO FISCAL):");
            System.out.println("- Al borrar la InfoFiscal, se borrará el Cliente y sus Compras.");
            
            infoFiscalCtrl.eliminarInfoFiscal(NIF_TEST);
            
            if (!clienteRepo.existsById(NIF_TEST)) {
                System.out.println(">>> ÉXITO: La cascada ha limpiado todas las tablas vinculadas.");
            }

            System.out.println("\n-------------------------------------------------");
            System.out.println(">>> PROYECTO FUNCIONANDO AL 100% <<<");
            System.out.println("-------------------------------------------------");

        } catch (Exception e) {
            System.err.println("\n>>> ERROR EN LA EJECUCIÓN: " + e.getMessage());
            e.printStackTrace();
        }
    }
}