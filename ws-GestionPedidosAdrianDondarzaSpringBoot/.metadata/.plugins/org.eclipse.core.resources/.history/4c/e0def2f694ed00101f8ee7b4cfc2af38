package com.adriandondarza.gestionpedidos.springboot.front;

import com.adriandondarza.gestionpedidos.springboot.GestionPedidosApplication;
import com.adriandondarza.gestionpedidos.springboot.controller.InfoFiscalController;
import com.adriandondarza.gestionpedidos.springboot.dto.InfoFiscalDTO;
import com.adriandondarza.gestionpedidos.springboot.model.*;
import com.adriandondarza.gestionpedidos.springboot.repository.*;
import org.springframework.boot.builder.SpringApplicationBuilder;
import org.springframework.context.ConfigurableApplicationContext;

import java.math.BigDecimal;
import java.time.LocalDateTime;

public class App {

    public static void main(String[] args) {
        // 1. Iniciar contexto de Spring Boot
        ConfigurableApplicationContext context = new SpringApplicationBuilder(GestionPedidosApplication.class)
                .profiles("dev")
                .run(args);

        // Generamos un NIF único para evitar conflictos de Primary Key en cada ejecución
        String nifPrueba = "B" + (int)(Math.random() * 999999);
        
        System.out.println("\n>>> INICIANDO CREACIÓN COMPLETA DE REGISTROS EN ORACLE <<<");

        // 2. Obtener componentes del contexto de Spring
        InfoFiscalController infoFiscalCtrl = context.getBean(InfoFiscalController.class);
        ClienteRepository clienteRepo = context.getBean(ClienteRepository.class);
        ArticuloRepository articuloRepo = context.getBean(ArticuloRepository.class);
        CompraRepository compraRepo = context.getBean(CompraRepository.class);
        ArticuloCompraRepository lineaRepo = context.getBean(ArticuloCompraRepository.class);

        try {
            // --- PASO 1: CREACIÓN DE INFOFISCAL Y CLIENTE (Relación Padre-Hijo) ---
            System.out.println("\n[1] Registrando InfoFiscal y Cliente (Cascada)...");
            
            InfoFiscalDTO dto = new InfoFiscalDTO();
            dto.setNifCif(nifPrueba);
            dto.setNombreCliente("Adrian Dondarza Prueba");
            dto.setDireccionFiscal("Avenida de la Constitución 45");
            dto.setTelefono("600123456");
            
            // El controlador inserta primero la InfoFiscal y por cascada el Cliente
            infoFiscalCtrl.registrarInfoFiscal(dto);
            System.out.println("- Registros creados con éxito. NIF: " + nifPrueba);

            // --- PASO 2: CREACIÓN DE ARTÍCULO ---
            System.out.println("\n[2] Creando un nuevo Artículo...");
            Articulo art = new Articulo();
            art.setNombre("Monitor Gaming 4K");
            art.setDescripcion("Monitor de 27 pulgadas con alta tasa de refresco");
            art.setPrecioActual(new BigDecimal("349.99"));
            art.setStock(15);
            art.setActivo(true);
            
            art = articuloRepo.save(art);
            System.out.println("- Artículo guardado con ID: " + art.getId());

            // --- PASO 3: CREACIÓN DE COMPRA VINCULADA ---
            System.out.println("\n[3] Generando la Compra para el nuevo cliente...");
            
            // Recuperamos el cliente que acaba de ser creado por la cascada de InfoFiscal
            Cliente cliente = clienteRepo.findById(nifPrueba).get();
            
            Compra compra = new Compra();
            compra.setCliente(cliente);
            compra.setFechaRealizada(LocalDateTime.now());
            compra.setEstado(EstadoCompra.PENDIENTE);
            compra.setPrecioTotal(art.getPrecioActual());
            compra = compraRepo.save(compra);

            // Creamos el detalle de la compra (Línea de pedido)
            ArticuloCompra detalle = new ArticuloCompra();
            detalle.setCompra(compra);
            detalle.setArticulo(art);
            detalle.setUnidades(1);
            detalle.setPrecioCompra(art.getPrecioActual());
            lineaRepo.save(detalle);

            System.out.println("- Todo ha sido creado y persistido en la base de datos.");
            System.out.println("- ID Compra generada: " + compra.getId());

            // --- PASO 4: BORRADO (COMENTADO PARA COMPROBAR DATOS) ---
            System.out.println("\n[4] SECCIÓN DE BORRADO (DESACTIVADA):");
            System.out.println(">>> Puedes ir a DBeaver para ver los datos. <<<");
            
            /* System.out.println("Ejecutando borrado de InfoFiscal...");
            // Si descomentas esto, se borraría la InfoFiscal y el Cliente, 
            // pero la Compra se quedaría con cliente_nif = NULL gracias a tu nuevo script.
            infoFiscalCtrl.eliminarInfoFiscal(nifPrueba);
            System.out.println("- Borrado ejecutado.");
            */

            System.out.println("\n-------------------------------------------------");
            System.out.println(">>> PRUEBA DE CREACIÓN FINALIZADA CON ÉXITO <<<");
            System.out.println("-------------------------------------------------");

        } catch (Exception e) {
            System.err.println("\n>>> ERROR DURANTE LA EJECUCIÓN: " + e.getMessage());
            e.printStackTrace();
        }
    }
}